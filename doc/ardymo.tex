%
% Documentation of the planar geometry algorithms used in the
% Mini Jam project du on October 31st, 2024.
% The game is called "Ardymo", a combination of "Arduino" and "Waymo"
%
% Compute the intersections of a straight line with an ellipse and
% a rectangle.
%
\documentclass[11pt]{article}
%
% Packages
%
\usepackage{subfig}
\usepackage{graphicx}
\usepackage{array}
\usepackage{amsmath,bm}
\usepackage{color}
\usepackage{booktabs}
\usepackage{hyperref}
%
% General
\pdfminorversion=6
% Dimensions
\setlength{\textwidth}{5.5in}
% \setlength{\textheight}{8.4in}
\setlength{\hoffset}{-0.25in}
% \setlength{\topmargin}{0pt}
\setlength{\parindent}{0pt}
\setlength{\parskip}{0.5\baselineskip}
%
% Definitions
% Mathematical symbols
\newcommand{\ahat}{\hat{a}}
\newcommand{\asig}{a_\sigma}
\newcommand{\bhat}{{\hat{b}}}
\newcommand{\bsig}{b_\sigma}
\newcommand{\diota}{d_\iota}
\newcommand{\Dsigl}{D_{\sigma l}}
\newcommand{\dsigl}{d_{\sigma l}}
\newcommand{\pb}{\mathbf{p}}
\newcommand{\pbc}{\mathbf{p}_c}
\newcommand{\pbl}{\mathbf{p}_l}
\newcommand{\pbs}{\mathbf{p}_s}
\newcommand{\pbiot}{\mathbf{p}_\iota}
\newcommand{\pbiotp}{\mathbf{p}_{\iota+}}
\newcommand{\pbiotm}{\mathbf{p}_{\iota-}}
\newcommand{\pbsig}{\mathbf{p}_\sigma}
\newcommand{\pxc}{p_{xc}}
\newcommand{\pyc}{p_{yc}}
\newcommand{\pxl}{p_{xl}}
\newcommand{\pyl}{p_{yl}}
\newcommand{\pxsig}{p_{x\sigma}}
\newcommand{\pysig}{p_{y\sigma}}
\newcommand{\Rb}{\mathbf{R}}
\newcommand{\Sb}{\mathbf{S}}
\newcommand{\vb}{\mathbf{v}}
\newcommand{\vbl}{\mathbf{v}_l}
\newcommand{\vxl}{v_{xl}}
\newcommand{\vyl}{v_{yl}}
\newcommand{\vbsig}{\mathbf{v}_\sigma}
\newcommand{\vbiot}{\mathbf{v}_\iota}
\newcommand{\vxsig}{v_{x\sigma}}
\newcommand{\vysig}{v_{y\sigma}}
\newcommand{\xb}{\mathbf{x}}
\newcommand{\Xhat}{\hat{X}}
\newcommand{\xhat}{{\hat{x}}}
\newcommand{\xiota}{x_\iota}
\newcommand{\xsig}{x_\sigma}
\newcommand{\Xsig}{X_\sigma}
\newcommand{\yb}{\mathbf{y}}
\newcommand{\yhat}{{\hat{y}}}
\newcommand{\yiota}{y_\iota}
\newcommand{\ysig}{y_\sigma}
% Labels and text
\newcommand{\eqn}[1]{(\ref{#1})}
\newcommand{\figref}[1]{Fig.~\eqref{#1}}
\newcommand{\tabref}[1]{Table~\eqref{#1}}
\newcommand{\TODO}{{\bf TODO}}
\newcommand{\segbool}{\text{\ttfamily segment}}
\newcommand{\true}{\textsf{true}}
\newcommand{\false}{\textsf{false}}
% For graphics alignment, not used in production
\newcommand{\HR}{\rule{1em}{0.4pt}}
\newcommand{\bluefbox}[1]{\textcolor{blue}{%
        \setlength\fboxsep{0pt}\fbox{\textcolor{black}{#1}}}}

\begin{document}
%
%
\title{Planar Geometry}
\author{Aurel Wisse}
\maketitle
%
%
\begin{abstract}
Documentation of the planar geometry algorithms used in the
Mini Jam project due on October 31st, 2024. We present the algorithms used to
compute the intersection of straight lines (sensor ray for identification
of obstacles) with circles, rectangles and line segments.
\end{abstract}
%
\pagebreak
\tableofcontents
\listoftables
\listoffigures
\pagebreak
%
\section{Geometric Objects}
\label{sec-geometric-objects}
\subsection{Straight Line}
\label{sec-straight-line}

\subsubsection{Unbound}
\label{sec-line-unbound}
We develop the representation of a straight line going through
points $\pb_0=(x_0, y_0)$ and $\pb_1=(x_1, y_1)$. 
Let us determine the points $\pb=(x, y)$ on the line.

Let $\vb=\pb_1-\pb_0$ the {\bf direction} of the line. The points $\pb$ on the 
line are given by
\begin{equation}
    \pb=\pb_0 + \tau \vb,\quad \tau\in\Rb \label{eq-line-general} \\
\end{equation}
The general line is illustrated in \figref{fig-general-line}
\begin{figure}
    \centering
    \includegraphics{odg/general-line.pdf}
    \caption{General Line}\label{fig-general-line}
\end{figure}


\subsubsection{Line Segment}
\label{sec-line-segment}
A line segment is the compact version of a straight line. It is of finite
length. The points on a {\bf canonical} line segment between $\pb_0$ and 
$\pb_1$ are given by
\begin{equation}
    \pb=\pb_0 + \tau \vb,\quad \tau\in[0,1] \label{eq-line-canonical}
\end{equation}
A general line segment is given by
\begin{equation}
    \pb=\pb_0 + \tau \vb,\quad \tau\in[a,b], \label{eq-line-ab}
\end{equation}
where $a<b$. It can easily be transformed into a canonical line segment.
\begin{equation}
    \pb_0+\tau \vb,\,\tau\in [a,b]\quad\Leftrightarrow\quad
    (\pb_0+a\vb) +\nu(b-a) \vb,\,\nu\in [0,1]
\end{equation}


\subsubsection{Rotation}
\label{sec-rotation-line}

A line given by $(\pb_0, \vb)$ can easily be rotated clockwise around 
$\pb_0$ by the angle $\alpha$. Define the rotation matrix $\Omega(\alpha)$.
\begin{equation}
    \Omega(\alpha)=\left(
    \begin{matrix}
        \cos(\alpha) & \sin(\alpha) \\
        -\sin(\alpha) & \cos(\alpha)
    \end{matrix}
    \right)\label{eq-rotation-matrix-Omega}
\end{equation}
The rotated line is given by $(\pb_0, \Omega(\alpha)\vb)$.

\subsection{Polygons}
\label{sec-polygons}

We are concerned with a general polygon in the two-dimensional plane. A polygon
with $n$ sides is well defined by $n$ points $\pb_0,\ldots,\pb_{n-1}$ 
defining $n$ line segments. The $n$ sides are defined by the line segments
\begin{equation}
    \left\{[\pb_i:\pb_{i+1}], i=0,\ldots,n-2\right\}\\
\cup\left\{[\pb_{n-1}:\pb_{0}]\right\}
\end{equation}
A polygon can be given a direction $\vb$  by using one of its line segments. 
Without losing generality, define 
\begin{equation*}
    \vb=\pb_1-\pb_0.
\end{equation*}
See also \figref{fig-general-line}.

\subsection{Rectangle}
\label{sec-rectangle}
A rectangle is a special case of a polygon. In Ardymo, we are using a directed
rectangle (a rectangle with a direction) as the vehicle. The vehicle has thus a
front and a back. The vehicle is given by four positon points
$\pb_i,\,i=0,\ldots,3,$ and four
direction vectors $\vb_0, \vb_1, \vb_2, \vb_3$, as illustrated in 
\figref{fig-vehicle-definition}. The direction of the vehicle is given by 
$\vb_0$.  Nous avons
\begin{eqnarray}
    \vb_{i+2} &=& -\vb_{i},\: i\in\{0,1\},\label{eq-v-v-rectangle} \\
    \pb_{i} &=& \pb_{i-1} + \vb_{i-1},\:i\in\{1,2,3\}.
\end{eqnarray}

\begin{figure}
    \centering
    \subfloat[Definition]
        {\includegraphics[trim=40 40 0 20]
        {odg/vehicle.pdf}\label{fig-vehicle-definition}}
    \subfloat[Rotation]
        {\includegraphics[trim=20 20 20 20]
        {odg/vehicle-turn-vector.pdf}\label{fig-vehicle-rotation}}
    \caption{Vehicle}\label{fig-vehicle}
\end{figure}

The vehicle is turning around the midpoint $\pb_c$ of the segment 
$[\pb_3:\pb_0]$, given by 
\begin{equation*}
    \pb_c = \pb_3 + \frac{1}{2}\vb_3.
\end{equation*}

In order to turn the rectangle clockwise by $\alpha$, we find new points 
$\pb'_i,i=0,\ldots,3$ and directional vectors $\vb'_i,i=0,\ldots,3$.
We have
\begin{eqnarray}
    \vb'_i &=& \Omega(\alpha)\vb_i,\quad i=0,\ldots,3 \\
    \pb'_0 &=& \pb_c + \Omega(\alpha)(\pb_0 - \pb_c) \\
    \pb'_i &=& \pb'_{i-1} + \vb'_{i-1},\quad i=1,\ldots,3
\end{eqnarray}
The rotation of the rectangle is illustrated in \figref{fig-vehicle-rotation}.

\subsection{Circle}
\label{sec-circle}

The standard implicit equation for a circle of radius $r$  centered at the
point $(x_0, y_0)$ is
\begin{equation}
    (x - x_0)^2 + (y - y_0)^2 = r^2\label{eq-circle}
\end{equation}

\TODO: We might generalize to an ellipsis later if this adds something
interesting to the gameplay:
\begin{equation}
    \frac{(x-x_0)^2}{a^2} + \frac{(y-y_0)^2}{b^2} = 1
\end{equation}

\section{Representation}
\label{sec-representation}
In this section we describe how circles, sensor rays and line segments will be
represented in code. There is no particular polygon object given that a
polygon is just a collection of line segments.

\subsection{Line}
\label{sec-representation-line}

The parameters for a line are $(\pb, \vb, \Sb)$, where $\pb=(p_{x}, p_{y})$ is
a point on the line and $\vb=(v_{x}, v_{y})$ is the direction of the line. The
parameter $\Sb$ is a boolean which is \false{} for an unbound line and \true{}
for a segment. A segment is defined by the points $\pb+t\vb,\,t\in[0,1]$.

\subsection{Rectangle}
\label{sec-representation-rectangle}

A rectangle is given by the parameters $(\pb, \vb, \mu)$, where 
$\pb=(p_{0}, p_{1})$ is the origin of the rectangle and $\vb=(v_{0}, v_{1})$ is
the direction of the rectangle. The width $w$ of the rectangle is given by
the length $\Vert\vb\Vert$ of $\vb$, given by
\begin{equation}
    w = \Vert\vb\Vert = \sqrt{v_{0}^2 + v_{1}^2}.\label{eq-width-rectangle}
\end{equation}
The height $h$ of the rectangle is given by
\begin{equation}
    h = \mu w.\label{eq-height-rectangle}
\end{equation}

The second directional parameter $\vb_1$ (section~\ref{sec-rectangle}) is given
by
\begin{equation}
    \vb_1 = \mu\Omega(90^\circ)\vb_0.\label{eq-vb1-rectangle}
\end{equation}
The remaining directional parameters, $\vb_2,\,\vb_3$ can be computed with
\eqref{eq-v-v-rectangle}.   

\subsection{Circle}

A circle in the 2-dimensional plane is fully defined by two parameters
$\pb, r$, where $\pb$ is the center of the circle and $r>0$ is the
radius of the circle.


\section{Intersection and Distance}
\label{sec-intersection-distance}

In this section, we determine the algoritm that finds the intersection of a
sensor ray  with an obstacle. If the intersection
exists, we also compute the distance of the origin $\pbsig$ of the
sensor ray to the obstacle. In the context of this application, it 
corresponds to a point on the vehicle from which the sensor ray emanates.

The general form of the distance $\diota$ between the origin of a sensor ray
$\pbsig$ and the point of intersection $\pbiot$ is given by
Pythagoras' Theorem (see also \eqref{eq-width-rectangle}).
\begin{equation}
    \diota = \Vert\pbsig-\pbiot\Vert
\end{equation}

\subsection{Line Segment}
\label{sec-intersection-line-segment}

\subsubsection*{Intersection}

The intersection of a sensor ray $(\pbsig,\vbsig)$ with a line segment
$(\pbl,\vbl)$ is given by parameters $\nu\in\Rb,\,\tau\in[0,1]$ such that
\begin{eqnarray}
    \pbsig + \nu \vbsig = \pbl + \tau \vbl. \label{eq-intersection-segment}
\end{eqnarray}

Writing \eqref{eq-intersection-segment} in cartesian coordinates,
\begin{equation}
    \pbsig=(\pxsig, \pysig),\:
    \vbsig=(\vxsig, \vysig),\:
    \pbl=(\pxl, \pyl),\:
    \vbl=(\vxl, \vyl),\label{eq-intersection-cartesian}
\end{equation}
we obtain a system of two linear equations
\begin{eqnarray*}
    \pxsig + \nu \vxsig &=& \pxl + \tau \vxl \\
    \pysig + \nu \vysig &=& \pyl + \tau \vyl 
\end{eqnarray*}
which can be transformed into the canonical form
\begin{equation}
    \left(
        \begin{matrix}
            \vxsig & -\vxl \\ \vysig & -\vyl
        \end{matrix}
    \right)
    \left(
        \begin{matrix}
            \nu \\ \tau
        \end{matrix}
    \right)
    = 
    \left(
        \begin{matrix}
            \pxl - \pxsig \\ \pyl - \pysig 
        \end{matrix}
    \right).\label{eq-intersection-linear-eq}
\end{equation}

A unique solution to \eqref{eq-intersection-linear-eq} exists if the
determinant $\Dsigl$ of the matrix is nonzero:
\begin{equation}
    \Dsigl=\det\left(
        \begin{matrix}
            \vxsig & -\vxl \\ \vysig & -\vyl
        \end{matrix}
    \right)=
    \vysig\vxl - \vxsig\vyl \neq 0.\label{eq-intersection-determinant}
\end{equation}
If however the determinant \eqref{eq-intersection-determinant} \textbf{is} 
zero, there exists a $\mu\in\Rb$ such that $\vbsig=\mu\vbl$ and an 
intersection exists \textbf{if and only if} there exists an $\eta\in\Rb$ such 
that $\pbl = \pbsig + \eta\vbl$.

The solution to \eqref{eq-intersection-linear-eq} is an intersection if
$\tau\in[0,1]$. It is given by
\begin{eqnarray}
\tau &=& \frac{\vxsig(\pyl - \pysig) - \vysig(\pxl - \pxsig)}{\Dsigl}
    \label{eq-intersection-tau}  \\
\nu &=& \frac{\vxl(\pyl-\pysig)-\vyl(\pxl-\pxsig)}{\Dsigl}
    \label{eq-intersection-nu}
\end{eqnarray}

To summarize, these are the steps to find an intersection between the sensor
ray and the line segment:
\begin{enumerate}
    \item Compute the determinant $\Dsigl$ \eqref{eq-intersection-determinant}.
    \item If $\Dsigl\neq 0$, compute $\tau$ \eqref{eq-intersection-tau}.
    \item If $\tau\in[0,1]$ the point of intersection is given by
        \eqref{eq-intersection-segment} and we are done.
    \item If $\Dsigl=0$, an intersection exists if the vectors $\pbl-\pbsig$ 
        and $\vbl$ are collinear, which means that we must have
        \begin{equation}
            \dsigl=(\pxl-\pxsig)\vyl - (\pyl - \pysig)\vxl=0.
            \label{eq-dsigl-zero}
        \end{equation}
        If \eqref{eq-dsigl-zero} is satisfied, the points of intersection are 
        given by $\pbl+\tau\vbl,\,\tau\in[0,1]$. 
\end{enumerate}

\subsubsection*{Distance}
If the intersection exists and is unique, and $\tau$ is given by
\eqref{eq-intersection-tau}, the distance $\delta$ between $\pbsig$ and the 
line segment $(\pbl, \vbl)$ is given by
\begin{equation}
    \delta = \Vert \pbsig - \pbl - \tau\vbl\Vert.
    \label{eq-distance-line-segment-unique}
\end{equation}

If $\Dsigl=0$ and equation~\eqref{eq-dsigl-zero} is satisfied, the distance
$\delta$ is given by
\begin{equation}
    \delta = \min\{\Vert\pbsig-\pbl\Vert, \Vert\pbsig-\pbl-\vbl\Vert\}
    \label{eq-distance-line-segment-collinear}
\end{equation}

\subsection{Rectangle}
\label{sec-intersection-rectangle}

The intersection of the sensor ray with a rectangle is given by the
intersection of one or two of the rectangles' line segments.

\subsection{Circle}
\label{sec-intersection-circle}
Let the circle be given by $(\pbc, r)$, where $\pbc=(\pxc, \pyc)$ is the 
center of the circle.

For the general case, the intersection of the sensor ray $(\pbsig, \vbsig)$
with the circle is given by the solutions $\xi$ of the equation
\begin{equation}
    \Vert\pbsig + \xi\vbsig - \pbc\Vert^2 = r^2\label{eq-intersection-circle}
\end{equation}

Expanding \eqref{eq-intersection-circle}, and defining
\begin{eqnarray}
    a &=& \vxsig^2+\vysig^2 \\
    b &=& 2(\vxsig(\pxsig-\pxc)+\vysig(\pysig-\pyc)) \\
    c &=& (\pxsig-\pxc)^2 + (\pysig-\pyc)^2
\end{eqnarray}
we obtain the equation
\begin{gather}
    (\pxsig+\xi\vxsig-\pxc)^2 + (\pysig+\xi\vysig-\pyc)^2 - r^2 = 0\\
    \Leftrightarrow\quad a^2\xi^2 + b\xi + c = 0\label{eq-quadratic-equation}
\end{gather}
If they exist, one or two solutions to \eqref{eq-quadratic-equation} are 
given by
\begin{equation}
    \xi = \frac{-b\pm\sqrt{b^2-4ac}}{2a}\label{eq-quadratic-solutions}
\end{equation}
An intersection exists if a solution \eqref{eq-quadratic-solutions} exists. The
condition for the existence of a solution is $b^2-4ac=0$ which requires
\begin{equation}
    (\vxsig(\pysig-\pyc)+\vysig(\pxsig-\pxc))^2 = r^2(\vxsig^2+\vysig^2).
    \label{eq-condition-intersection-circle}
\end{equation}

Given the solutions $\xi_-,\xi_+$ to \eqref{eq-quadratic-solutions}, the points
of intersection  $\pbiotp,\pbiot-$ of the sensor ray with the circle are given 
by
\begin{equation}
    \pbiotp=\pbsig + \xi_+\vbsig\qquad\pbiotm=\pbsig + \xi_-\vbsig.
\end{equation}
The distance $\diota$ between the origin $\pbsig$ of the sensor ray and the
circle is given by
\begin{equation}
    \diota = \min\{\Vert\pbsig-\pbiotp\Vert,\Vert\pbsig-\pbiotm\Vert\}
    \label{eq-distance-circle}
\end{equation}

\section{Game Objects}
\label{sec-game-objects}
There are four types of objects in the game.
\begin{enumerate}
    \item The game surface. A rectangle with $(0,0)$ in the upper left corner.
        It is defined by two values $x_G > 0, y_G>0$ respectively on the x-axis
        and the y-axis.
    \item The {\sl vehicle} which is a rectangle with a direction $\alpha$
    \item The target which is a single point $T = (x_T, y_T)$ on the game
        surface.
    \item The obstacles. A collection of line segments and circles.
\end{enumerate}

\section{The Game}
\label{sec-the-game}
\begin{itemize}
    \item There are two players in the game, one on each Arduboy.
    \item The objective of the game is to reach the target first without
        running into an obstacle.
    \item Running into an obstacle requires a repair of the vehicle and leads
        to a 30 second suspension.
    \item Colliding with the other players car from the side or behind places
        the player at the start with a 30 second suspension.
    \item A frontal collision of both players ends the game without a winner.
\end{itemize}

\subsection{User Interface}
\label{sec-user-interface}
The main screen \figref{fig-main-screen}.
\begin{figure}
    \includegraphics[width=\textwidth]{odg/screen.pdf}
\caption{Mockup of the main game screen}\label{fig-main-screen}
\end{figure}
\begin{itemize}
    \item The numbers next to the four triangles, top, left right and botton
        show the distance to the nearest object (obstacle or target).
    \item The arrow points towards the north, parallel to the x-axis.
    \item The dot on the circle shows in which direction the target is
        located.
    \item The elapsed game time is the number at the top left in the white
        rectangle.
    \item The distance to the target is the number below the elapsed time.
\end{itemize}

\subsection{Game Map}
\label{sec-game-map}
The game map is a rectangle given by two values $x_M, y_M > 0$. The resulting
rectangle is defined by the four points
\begin{equation*}
    \{(0,0), (x_M, 0), (0, y_M), (x_M, y_M)\}
\end{equation*}
The map is filled with two vehicles, one for each player, a target and
obstacles which are a collection of line segments and circles.

Given that the map can be quite big, no bitmap representation of the game map
is displayed on the Arduboy. However, the map can be converted to a bitmap
with a suitable drawing program. Ultimately, a small program for conversion
into an SVG file can be written.

\subsection{Controls}
\label{sec-controls}

\begin{tabular}{>{\sffamily\bfseries}ll}
    Up Button & Accelerate forward $1m/s^2$. \\
    Down Button & Accelerate backwards (also "braking").\\
    Left Button & Turn left $\alpha$ degrees.\\
    Right Button & Turn right $\alpha$ degrees.\\
    A Button & TBD.\\
    B Button & Show menu.\\
\end{tabular}

\subsection{Vehicle Movement}
\label{sec-vehicle-movement}

The vehicle is defined as a rectangle given by four points. Two points at the
front of the vehicle and two points at the rear of the vehicle. These points
define four line segments.

Turning the vehicle with the left or right button rotates the four buttons
around the midpoint of the two points at the rear of the vehicle, as
illustrated in \figref{fig-vehicle-rotate}.
\begin{figure}
    \centering
    \includegraphics[trim=0 30 0 30]{odg/vehicle-turn.pdf}
    \caption{Vehicle Turn}\label{fig-vehicle-rotate}
\end{figure}
The vehicles' forward movement is in the direction of the front of the vehicle
parallel to the sides of the vehicle.
The vehicles' backward movement is in the direction of the rear of the vehicle
parallel to the sides of the vehicle.

\subsection{Target and Obstacles}
\label{sec-obstacles}

The obstacles are line segments and circles. The target is a circle. The
vehicle is a rectangle. The limits of the game map are obstacles.

\pagebreak
\section{Scanning}
\label{sec-scanning}
In each frame, the vehicle scans for obstacles in the following way.

The straight lines prolonging the sides of the vehicle are checked for
intersections with all obstacles in the list. The distance to the closest
obstacle is displayed on the user interface.

The straight line perpendicular to the vehicle and running through the center
of the vehicle is checked for intersections with all obstacles in the list.
The distance to the closest obstacle is displayed on the user interface
\figref{fig-scanning}.

\begin{figure}
    \centering
    \includegraphics{odg/scanning.pdf}
    \caption{Scanning and Distance}\label{fig-scanning}
\end{figure}

\appendix
\section{Rotation Matrix}
\label{appendix-rotation-matrix}
A general rotation matrix $\Omega(\alpha)$ for clockwise rotation in the
2-dimensional plane by the angle $\alpha$ is given by
\begin{equation}
    \Omega(\alpha) = \begin{pmatrix}
        \cos(\alpha) & -\sin(\alpha) \\
        \sin(\alpha) & \cos(\alpha)
    \end{pmatrix}
\end{equation}

\section{Proofs for rectangle intersections}
\label{appendix-proofs-rectangle-intersections}

\end{document}

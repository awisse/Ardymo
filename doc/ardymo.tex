%
% Documentation of the planar geometry algorithms used in the
% Mini Jam project du on October 31st, 2024.
% The game is called "Ardymo", a combination of "Arduino" and "Waymo"
%
% Compute the intersections of a straight line with an ellipse and
% a rectangle.
%
\documentclass[11pt]{article}
%
% Packages
%
\usepackage{graphicx}
\usepackage{array}
\usepackage{amsmath,bm}
\usepackage{color}
\usepackage{booktabs}
%
% General
\pdfminorversion=6
% Dimensions
% \setlength{\textwidth}{5.5in}
% \setlength{\textheight}{8.4in}
% \setlength{\hoffset}{-0.25in}
% \setlength{\topmargin}{0pt}
\setlength{\parindent}{0pt}
\setlength{\parskip}{0.5\baselineskip}
%
% Definitions
% Mathematical symbols
\newcommand{\asig}{a_\sigma}
\newcommand{\bhat}{{\hat{b}}}
\newcommand{\bfx}{\mathbf{x}}
\newcommand{\bsig}{b_\sigma}
\newcommand{\diota}{d_\iota}
\newcommand{\xhat}{{\hat{x}}}
\newcommand{\xiota}{x_\iota}
\newcommand{\xsig}{x_\sigma}
\newcommand{\Xsig}{X_\sigma}
\newcommand{\yhat}{{\hat{y}}}
\newcommand{\yiota}{y_\iota}
\newcommand{\ysig}{y_\sigma}
\newcommand{\Rb}{{\mathbf{R}}}
% Labels and text
\newcommand{\eqn}[1]{(\ref{#1})}
\newcommand{\figref}[1]{Fig.~\eqref{#1}}
\newcommand{\TODO}{{\bf TODO}}
% For graphics alignment, not used in production
\newcommand{\HR}{\rule{1em}{0.4pt}}
\newcommand{\bluefbox}[1]{\textcolor{blue}{%
        \setlength\fboxsep{0pt}\fbox{\textcolor{black}{#1}}}}

\begin{document}
%
%
\title{Planar Geometry}
\author{Aurel Wisse}
\maketitle
%
%
\begin{abstract}
Documentation of the planar geometry algorithms used in the
Mini Jam project due on October 31st, 2024. We present the algorithms used to
compute the intersection of straight lines (sensor ray for identification
of obstacles) with circles, rectangles and line segments.
\end{abstract}

%
\section{Straight Line}
\label{sec-straight-line}

\subsection{Unbound}
\label{sec:unbound}
We develop the representation of a straight line going through
coordinates $(x_0, y_0)$ and $(x_1, y_1)$. Let us determine the points $(x,
y)$ on the line.

We have two special cases:
\begin{eqnarray}
    (x, y) &=& (x_0, y)\quad\forall y\in\Rb\quad \text{ if } x_1 = x_0
    \label{eq-line-xx0} \\
    (x, y) &=& (x, y_0)\quad\forall x\in\Rb\quad \text{ if } y_1 = y_0
    \label{eq-line-yy0}
\end{eqnarray}

For the general case, $x_0 \neq x_1 \land y_0 \neq y_1$, we have
\begin{eqnarray}
    y &=& ax+b,\quad \forall x\in\Rb\quad \text{where}\label{eq-line-general}\\
    a &=& \frac{y_0 - y_1}{x_0 - x_1}, \notag \\
    b &=& \frac{x_0 y_1 - y_0 x_1}{x_0 - x_1} \notag
\end{eqnarray}

\subsection{Line Segment}
\label{sec-line-segment}
A line segment is the compact version of a straight line. It is of finite
length. For the special case $x_0 = x_1$ the points $(x, y)$ on the line
segment $[(x_0, y_0):(x_0, y_1)]$ between $(x_0, y_0)$ and $(x_0, y_1)$ are
given by
\begin{equation}
    (x, y) = (x_0, y)\quad y\in [y_0, y_1]\label{eq-seg-x1x0}
\end{equation}

For the special case $y = b$ the points $(x, y)$ on the line segment
$[(x_0, b):(x_1, b)]$ are given by
\begin{equation}
    (x, y) = (x, b)\quad x\in [x_0, x_1]\label{eq-seg-yb}
\end{equation}

For the general case given by \eqn{eq-line-general}, the points $(x, y)$ on
the line segment $[(x_0, y_0):(x_1, y_1)]$ are given by
\begin{equation}
    (x, y) = (x, ax + b)\quad x\in [x_0, x_1]\label{eq-seg-general}
\end{equation}
where $a\neq 0$.

\section{Polygons}
\label{sec-polygons}

We are concerned with a general polygon in the two-dimensional plane. A polygon
with $n$ sides is well defined by $n$ line segments and $n$ points $(x_0,
y_0),\ldots,(x_{n-1}, y_{n-1})$. The $n$ sides are defined by the line segments
\begin{equation}
    \left\{[(x_i, y_i):(x_{i+1}, y_{i+1})], i=0,\ldots,n-2\right\}\\
\cup\left\{[(x_{n-1}, y_{n-1}):(x_{0}, y_{0})]\right\}
\end{equation}

\section{Rectangle}
\label{sec-rectangle}
While general polygons are useful as obstacles, they lack the direction
information we need for the vehicle.  Hence we define a rectangle with five
parameters by starting with a rectangle of which the sides are parallel to
the x-axis and the y-axis, given by the four parameters
\begin{enumerate}
    \item $(x_0, y_0)$ the center of the left side of the rectangle.
    \item $w$ the width (x-direction) of the rectangle.
    \item $h$ the height (y-direction) of the rectangle.
\end{enumerate}
The fifth parameter $\alpha$ represents the clockwise rotation of the
rectangle around the point $\left(x_0, y_0\right)$. The parameters are
illustrated in \figref{fig-rectangle}.

\begin{figure}
    \centering
    \includegraphics[trim=10 40 10 20]{rectangle.pdf}
    \caption{Rotated Rectangle}\label{fig-rectangle}
\end{figure}

\section{Circle}
\label{sec-circle}

The standard implicit equation for a circle of radius $r$  centered at the
point $(x_0, y_0)$ is
\begin{equation}
    (x - x_0)^2 + (y - y_0)^2 = r^2\label{eq-circle}
\end{equation}

\TODO: We might generalize to an ellipsis later if this adds something
interesting to the gameplay:
\begin{equation}
    \frac{(x-x_0)^2}{a^2} + \frac{(y-y_0)^2}{b^2} = 1
\end{equation}

\section{Representation}
\label{sec-representation}
In this section we describe how circles, sensor rays and line segments will be
represented in code. There is no particular polygon object given that a
polygon is just a collection of line segments.

\subsection{Unbound Straight Line}


Parameters $(a, b, X, z_0, z_1)$.
The parameters $z_0, z_1$ are set to zero for an unbound line. They define
the endpoints of a line segment.

\begin{enumerate}
    \item For an unbound straight horizontal line, $a=X=0, y=b$.
    \item For an unbound straight vertical line, $a=b=0, x=X$.
    \item For an unbound general line, $X=0$.
\end{enumerate}

\subsection{Line Segment}
\label{sec-representation-line-segment}

Parameters $(a, b, X, z_0, z_1)$.

Covers all cases. We must define a transformation of the points $(x_0, y_0)$
and $(x_1, y_1)$  into a general straight line with constraints on $x$ and $y$.
\begin{equation}
    (a, b, X, z_0, z_1) =
    \begin{cases}
        (0, y_0, 0, x_0, x_1)  &
        \text{if $y_1 = y_0\land x_0 < x_1$}\\
        (0, 0, x_0, y_0, y_1) &
        \text{if $x_1 = x_0\land  y_0 < y_1 $}\\
        \left(\frac{y_0 - y_1}{x_0-x_1},
            \frac{x_0 y_1 - x_1 y_0}{x_0 - x_1}, 0, x_0, x_1\right) &
            \text{if $x_0< x_1\,\land\,y_0< y_1$}
    \end{cases}
\end{equation}

\subsection{Rectangle}

A rectangle is given by the parameters $(x_0, y_0, w, h, \alpha)$
(Section~\ref{sec-rectangle}).


\subsection{Circle}

Parameters $x_0, y_0, r$.


\section{Intersection and Distance}
\label{sec-intersection-distance}

In this section, we determine the algoritm that finds the intersection of a
sensor ray $(\asig, \bsig, \Xsig, 0, 0)$ with an obstacle. If the intersection
exists, we compute the distance of the origin $(\xsig, \ysig)$ of the sensor
ray to the obstacle.

The general form of the distance $d$ between the origin of the sensor ray
$(\xsig,\ysig)$ and the point of intersection $(\xiota,\yiota)$ is given by 
Pythagoras' Theorem:
\begin{equation}
    \diota = \sqrt{(\xiota-\xsig)^2 + (\yiota-\ysig)^2}
\end{equation}

\subsection{Line Segment}
\label{sec-intersection-line-segment}

\subsubsection*{Intersection}

We must consider the intersections of all three possibilities of sensor rays
$(x, y) =(\xsig, y)$ \eqref{eq-line-xx0}, $(x, y)=(x, \bsig)$ 
\eqref{eq-line-yy0} and $(x, y) = (x, \asig x+\bsig)$
\eqref{eq-line-general} with all three possibilities of line segments
$x_{s0}=x_{s1}$ \eqref{eq-seg-x1x0}, $y_{s0}=y_{s1}$ \eqref{eq-seg-yb} and
$y=a_{s}x+b_{s}$ \eqref{eq-seg-general}, where $(x_{s0}, x_{s1})$ are the
limits of the $x$-parameter, $(y_{s0}, y_{s1})$ the limits of the
$y$-parameter and $(a_{s}, b_{s}),\,a_{s}\neq 0$ the parameters of the 
general case
\eqref{eq-seg-general}.

We present the conditions for intersections of the sensor ray (first column)
with the line segments (first row) in
table~\eqref{tab-condition-intersection-seg}.
% Definitions: Math mode columns
\newcolumntype{C}{>{$\scriptstyle}c<{$}}
\newcolumntype{L}{>{$\scriptstyle}l<{$}}
% Table: Conditions for intersection with line segments
\begin{table}
    \centering
    \begin{tabular}{LCCC}
    \toprule
        \multicolumn{1}{c}{Sensor}&\multicolumn{3}{c}{Line Segment} \\
    \cmidrule(l){2-4}
    \multicolumn{1}{c}{Ray}& x_{s1}=x_{s0} & y_{s1}=y_{s0} & a_{s}x + b_{s}\\
    \hline
    x=\xsig & \xsig=x_{s0} & 
        \multicolumn{2}{C}{x_{s0}\leq \xsig\leq x_{s1}} \\
    y=\bsig & y_{s0}\leq \bsig \leq y_{s1} & \bsig=y_{s0} &
    a_s x_{s0}\leq \bsig - b_s\leq a_s x_{s1} \\
    \asig x+\bsig & y_{s0}\leq \asig x_{s0}+\bsig\leq y_{s1} &
    \asig x_{s0}\leq y_{s0}-\bsig\leq \asig x_{s1} &
    \left\{\begin{tabular}{C}\asig=a_s\,\land\,\bsig=b_s\\ \text{or}\\
            x_{s0}\leq \frac{\bsig - b_s}{a_s-\asig}\leq x_{s1}
        \end{tabular}\right\}\\
    \bottomrule
    \end{tabular}
    \caption{Conditions for intersections with line segments}\label{tab-condition-intersection-seg}
\end{table}

\subsubsection*{Distance}
Provided an intersection exists, we can compute the distance from $(x_\sigma,
y_\sigma)$ the origin of the sensor ray to the obstacle. In 
Table~\eqref{tab-distance-seg}, we present the distances for all ten cases of
existing intersections seen in Table~\eqref{tab-condition-intersection-seg}.

All ten cases must be handled provided a corresponding intersection exists.
% Table: Distance from origin of sensor ray to obstacle
\begin{table}
    \centering
    \begin{tabular}{LLL}
    \toprule
    \multicolumn{1}{l}{Sensor Ray}&\multicolumn{1}{l}{Line Segment}&
    \multicolumn{1}{l}{Distance}\\
    \midrule
    % a) (x,y) = (x, \bsig)
    y=\bsig & x_{s1}=x_{s0} & |\xsig - x_{s0}| \\
    & y_{s1}=y_{s0} & \min\{|\xsig - x_{s0}|,|\xsig - x_{s1}| \\
    & a_s x + b_s & \left|\xsig - \frac{b_s - \bsig}{a_s}\right| \\
    % a) (x,y) = (\xsig, y)
    \midrule[0.5pt]
    x=\xsig & x_{s1}=x_{s0} & \min\{|\ysig - y_{s0}|,|\ysig - y_{s1}|\} \\
    & y_{s1}=y_{s0} & |\ysig - y_{s0}| \\
    & a_s x + b_s & \left|\ysig - a_s\xsig - \bsig\right| \\
    \midrule[0.5pt]
    % a) (x,y) = (x, \asig x + \bsig)
    y=\asig x + \bsig & x_{s1}=x_{s0} & 
    \sqrt{(x_{s0}-\xsig)^2 + (\asig x_{s0} + \bsig - \ysig)^2} \\
    & y_{s1}=y_{s0} & 
        \sqrt{\left(\frac{y_{s0}-\bsig}{\asig} - \xsig\right)^2
            + (y_{s0} - \ysig)^2}\\
    & a_s x + b_s, a_s=\asig\land b_s=\bsig & 
        \sqrt{\min_{j=0,1}\{(x_{sj}-\xsig)^2+(y_{sj}-\ysig)^2\}} \\
    & a_s x + b_s, a_s\neq\asig\land b_s\neq\bsig & 
    \sqrt{\left(\frac{\bsig-b_s}{a_s-\asig}-\xsig\right)^2
    +\left(\frac{a_s\bsig-\asig b_s}{a_s-\asig}+b_s-\ysig\right)^2} \\
    \bottomrule
    \end{tabular}
    \caption{Distance from origin of sensor ray to
    intersection}\label{tab-distance-seg}
\end{table}

\subsection{Rectangle}
\label{sec-intersection-rectangle}

A rectangle is given by the parameters $(x_0, y_0, w, h, \alpha)$
(Section~\ref{sec-rectangle}). The rectangle is defined at the origin with
width $w$ and height $h$. The upper left corner of the rectangle at the
origin is at the point $\left(-\frac{h}{2},0\right)$.
The points of the rectangle are rotated clockwise around the origin by
$\alpha$ and translated by adding the vector
$(x_0, y_0)$.

There are two ways to determine the intersection of the sensor ray with the
rectangle.
\begin{enumerate}
    \item Transform the rectangle into four line segments and
        proceed with the algorithm in
        section~(\ref{sec-intersection-line-segment}) for each segment.
    \item Rotate and translate the sensor ray by the inverse transformation of
        the rectangle: Translate by $(-x_0, -y_0)$ and rotate by $\-alpha$.
\end{enumerate}
We are using the second approach.

Let $(x, y)$ be a point on the sensor ray. Let $(\xhat, \yhat)$ the
corresponding transformed point, given by
\begin{eqnarray}
    \xhat &=& (x - x_0) \cos(\alpha) + (y - y_0) \sin(\alpha) \\
    \yhat &=& (x_0 - x) \sin(\alpha) + (y - y_0) \cos(\alpha)
\end{eqnarray}

\subsection{Circle}
\label{sec-intersection-circle}
For the sensor ray, we must consider the three cases $(x,y)=(x_0,y)\,\forall y$
\eqref{eq-line-xx0}, $(x,y)=(x,y_0)\,\forall x$ \eqref{eq-line-yy0} and $y=ax+b$
\eqref{eq-line-general}.

Let $(x_c, y_c)$ be the center of the circle.

For the case $(x,y)=(x_0, y)$, the intersection with the circle
$(x-x_c)^2+(y-y_c)^2=r^2$ is given by
\begin{equation}
    y = y_c \pm\sqrt{r^2 - (x_0-x_c)^2}.
\end{equation}
If $r^2 < (x_0-x_c)^2$, there is no intersection with the circle.

For the case $(x,y)=(x, y_0)$, the intersection with the circle
$(x-x_c)^2+(y-y_c)^2=r^2$ is given by
\begin{equation}
    x = x_c \pm\sqrt{r^2 - (y_0-y_c)^2}.
\end{equation}
If $r^2 < (y_0-y_c)^2$, there is no intersection with the circle.

For the general case, the intersection of a
straight line $y=ax+b$ with a circle $(x-x_c)^2+(y-y_c)^2=r^2$ is given by
\begin{equation}
    (x-x_c)^2 + (ax+b - y_c)^2 = r^2
\end{equation}
In order to simplify calculations, we translate the origin to $(x_c, y_c)$. Let
\begin{equation}
    \xhat = x-x_c,\quad \yhat = y-y_c,\quad \bhat = ax_c + b - y_c.
\end{equation}
The intersection of the straight line $\yhat = a\xhat + \bhat$ with the circle
$\xhat^2 + \yhat^2 = r^2$ is given by
\begin{equation}
    \xhat^2 + (a\xhat + \bhat)^2 = r^2 \label{eq-intersection-circle}
\end{equation}
The solutions $\xhat$ to \eqref{eq-intersection-circle} are given by
\begin{equation}
    \xhat = -\frac{a\bhat}{1+a^2}\pm
        \sqrt{\frac{1}{1+a^2}\left(r^2-\bhat+\frac{a^2 \bhat^2}{1+a^2}\right)}
\end{equation}
From this, we see that if
\begin{equation}
    r^2-\bhat+\frac{a^2 b^2}{1+a^2} < 0,
\end{equation}
there is no intersection of the line and the circle.

\section{Game Objects}
\label{sec-game-objects}
There are four types of objects in the game.
\begin{enumerate}
    \item The game surface. A rectangle with $(0,0)$ in the upper left corner.
        It is defined by two values $x_G > 0, y_G>0$ respectively on the x-axis
        and the y-axis.
    \item The {\sl vehicle} which is a rectangle with a direction $\alpha$
    \item The target which is a single point $T = (x_T, y_T)$ on the game
        surface.
    \item The obstacles. A collection of line segments and circles.
\end{enumerate}

\section{The Game}
\label{sec-the-game}
\begin{itemize}
    \item There are two players in the game, one on each Arduboy.
    \item The objective of the game is to reach the target first without
        running into an obstacle.
    \item Running into an obstacle requires a repair of the vehicle and leads
        to a 30 second suspension.
    \item Colliding with the other players car from the side or behind places
        the player at the start with a 30 second suspension.
    \item A frontal collision of both players ends the game without a winner.
\end{itemize}

\subsection{User Interface}
\label{sec-user-interface}
The main screen \figref{fig-main-screen}.
\begin{figure}
    \includegraphics[width=\textwidth]{screen.pdf}
\caption{Mockup of the main game screen}\label{fig-main-screen}
\end{figure}
\begin{itemize}
    \item The numbers next to the four triangles, top, left right and botton
        show the distance to the nearest object (obstacle or target).
    \item The arrow points towards the north, parallel to the x-axis.
    \item The dot on the circle shows in which direction the target is
        located.
    \item The elapsed game time is the number at the top left in the white
        rectangle.
    \item The distance to the target is the number below the elapsed time.
\end{itemize}

\subsection{Game Map}
\label{sec-game-map}
The game map is a rectangle given by two values $x_M, y_M > 0$. The resulting
rectangle is defined by the four points
\begin{equation*}
    \{(0,0), (x_M, 0), (0, y_M), (x_M, y_M)\}
\end{equation*}
The map is filled with two vehicles, one for each player, a target and
obstacles which are a collection of line segments and circles.

Given that the map can be quite big, no bitmap representation of the game map
is displayed on the Arduboy. However, the map can be converted to a bitmap
with a suitable drawing program. Ultimately, a small program for conversion
into an SVG file can be written.

\subsection{Controls}
\label{sec-controls}

\begin{tabular}{>{\sffamily\bfseries}ll}
    Up Button & Accelerate forward $1m/s^2$. \\
    Down Button & Accelerate backwards (also "braking").\\
    Left Button & Turn left $\alpha$ degrees.\\
    Right Button & Turn right $\alpha$ degrees.\\
    A Button & TBD.\\
    B Button & Show menu.\\
\end{tabular}

\subsection{Vehicle Movement}
\label{sec-vehicle-movement}

The vehicle is defined as a rectangle given by four points. Two points at the
front of the vehicle and two points at the rear of the vehicle. These points
define four line segments.

Turning the vehicle with the left or right button rotates the four buttons
around the midpoint of the two points at the rear of the vehicle, as
illustrated in \figref{fig-vehicle-rotate}.
\begin{figure}
    \centering
    \includegraphics[trim=0 30 0 30]{vehicle-turn.pdf}
    \caption{Vehicle Turn}\label{fig-vehicle-rotate}
\end{figure}
The vehicles' forward movement is in the direction of the front of the vehicle
parallel to the sides of the vehicle.
The vehicles' backward movement is in the direction of the rear of the vehicle
parallel to the sides of the vehicle.

\subsection{Target and Obstacles}
\label{sec-obstacles}

The obstacles are line segments and circles. The target is a circle. The
vehicle is a rectangle. The limits of the game map are obstacles.

\pagebreak
\section{Scanning}
\label{sec-scanning}
In each frame, the vehicle scans for obstacles in the following way.

The straight lines prolonging the sides of the vehicle are checked for
intersections with all obstacles in the list. The distance to the closest
obstacle is displayed on the user interface.

The straight line perpendicular to the vehicle and running through the center
of the vehicle is checked for intersections with all obstacles in the list.
The distance to the closest obstacle is displayed on the user interface
\figref{fig-scanning}.

\begin{figure}
    \centering
    \includegraphics{scanning.pdf}
    \caption{Scanning and Distance}\label{fig-scanning}
\end{figure}

\end{document}
